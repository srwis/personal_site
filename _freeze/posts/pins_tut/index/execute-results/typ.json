{
  "hash": "a7ecc7f3f02c4ffc3bb4b9942edd59d8",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Upload pins for use with data explorer app\"\nauthor: \"Sadie Wisotsky\"\ndate: \"2025-9-29\"\nexecute: \n  eval: false\nformat:\n  html:\n    toc: true\n    embed-resources: true\n  typst: default\n \n---\n\n## Purpose\n\nThis should walk a user through adding data to the pins folder on sharepoint and getting it to show up in the data sharing app on the shiny-server.\n\n### Get your data\n\nfirst read the data in that you want to upload\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n\niris.dat <- data(iris)\n```\n:::\n\n\ntake a peak at the data and also here is where you'd do any data manipulation to it (add columns, calculations, etc. )\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(iris)\n```\n:::\n\n\n\n\n### connect to the sharepoint\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(pins)\n#library(Microsoft365R)\n\nsite <- \"[placeholder]\"\nfolder <- \"../pins/tutorial\" #change the folder based on where you wish the pins to end up. can also make a new folder for a new study or project\n\n\n\n# only needed if pins are stored remotely on a sharepoint site\n#sp <- get_sharepoint_site(site_id = site)  \n#doclib <- sp$get_drive()\n#board <- board_ms365(doclib, folder) \n```\n:::\n\n\ncan take a peak at the pins that already exist in this folder. Note that the pins listed here will not necessarily reflect the pins listed in the app because of the Upload = TRUE metadata step we will show later.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npin_list(board)\n```\n:::\n\n\n## create new pin\n\nhere we are going to use pin_write to create a new pin in the folder. For the app, I've tried to include column names, a short description of the data, and some informative tags you will see how they get added here. additionally in the custom metadata section I have added a flag called \"Upload\", if \"Upload\" = TRUE then the data is meant to appear in the data delivery app. If \"Upload\" is FALSE or missing, it will not appear in the data delivery app. This should allow BFX to use the same pins folders for BFX only work and for end stage data delivery.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncnames <- colnames(iris) # get column names\n\ndesc <- \"default IRIS data for pins upload vingette\"\n\npin_write(board,\n          iris,\n          name = \"IRIS\",\n          #title = meta$title,\n          description = desc,\n          metadata = list(\n            \"Column Names\" = cnames,\n            \"Upload\" = TRUE #change if you do not wish to share with the app \n          ),\n          tags = c(\"example\", \"IRIS\"),\n          type = \"rds\",\n          force_identical_write = TRUE # forces rewrite with changed metadata. otherwise only over writes if data itself has changed.\n)\n```\n:::\n\n\ncheck out the pin's metadata\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmeta <- pin_meta(board, \"IRIS\")\nmeta\n```\n:::\n\n\n## Add pin to the app\n\nso now the pin is officially in the pins sharepoint folder and should have the correct metadata.\n\nthe next step to get it to show up in the app is to add it to the pin called `metadata_list` that I created for each study.\n\nthis exists because mapping over each pin and reading its data in real time was slowing down the app. so we do this before hand; outside of the app. But it means a pin will not show up in the app until this list has been refreshed by running this code\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlist.of.pins <- pin_list(board)\nmetas <- purrr::map(list.of.pins, purrr::possibly(.f = \\(x) pin_meta(board, x), \n                                           otherwise= \"error\"))\n \n\npin_write( board = board, metas, name = \"metadata_list\", type = \"rds\")\n```\n:::\n\n\n## look at the metadata_list\n\nif you are curious about what is in the metadata_list pin you can find out with:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmdl <- pin_read(board, \"metadata_list\")\nmdl |> glimpse()\n```\n:::\n\n\n\n## code from the app\n\nif you are wondering why these steps are necessary the code for the app may be good to look at:\n\n``` {#overview .R}\n    if (\"metadata_list\"%in%all.pins == TRUE) {\n      metas <- pin_read(values$hi, \"metadata_list\")\n    }\n    else{\n      metas <- purrr::map(all.pins, \n                          possibly(.f = \\(x) pin_meta(values$hi, x)))\n    }\n    \n    values$ups  <- data.frame(\n      names = map(metas, ~pluck(., \"name\", \n                                .default = \"skip\")) %>% unlist(),\n      upload =map(metas, ~pluck(., \"user\", \"Upload\", \n                                .default = \"FALSE\"))%>% \n        unlist(),\n      tags = map(metas, ~pluck(., \"tags\",  \n                               .default = \"FALSE\") %>% \n                   paste(collapse = \",\")) %>% unlist(),\n      ext = map(metas, ~pluck(., \"file\",\n                              .default = \"rds\")) |> unlist()\n    )\n```\n\nbasically, for every study folder, the code looks for a pin called metadata_list and if it exists, reads it in. If it doesn't exist then it takes a minute to map over all the pins in a folder and read in the metadata for them while the app is live (this can take a long time depending on the number of pins in a folder.)\n\nand later on in the app the code populates the drop down choices with only the names of pins that have an Upload = TRUE value.",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}